<!-- Advanced Technical Analysis Chart Component -->
<!-- Premium Feature: Displays stock price with technical indicators -->

<div id="technical-chart-container" class="mt-6 bg-gradient-to-br from-gray-900/80 via-purple-900/20 to-gray-900/80 rounded-xl p-6 border border-purple-500/30 backdrop-blur-sm shadow-2xl">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
            <h3 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">
                ğŸ“ˆ ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æãƒãƒ£ãƒ¼ãƒˆ
            </h3>
            <span class="px-3 py-1 bg-gradient-to-r from-amber-500/20 to-orange-500/20 border border-amber-500/30 rounded-full text-xs text-amber-300 font-semibold">
                â­ PREMIUM
            </span>
        </div>

        <!-- Period Selector -->
        <div class="flex gap-2" id="period-selector">
            <button onclick="loadTechnicalChart('1M')" class="period-btn px-3 py-1 rounded-lg text-sm font-medium transition-all duration-200 bg-gray-800/50 text-gray-400 hover:bg-purple-600/30 hover:text-purple-300">
                1ãƒ¶æœˆ
            </button>
            <button onclick="loadTechnicalChart('3M')" class="period-btn px-3 py-1 rounded-lg text-sm font-medium transition-all duration-200 bg-purple-600/50 text-purple-200 border border-purple-500/50">
                3ãƒ¶æœˆ
            </button>
            <button onclick="loadTechnicalChart('6M')" class="period-btn px-3 py-1 rounded-lg text-sm font-medium transition-all duration-200 bg-gray-800/50 text-gray-400 hover:bg-purple-600/30 hover:text-purple-300">
                6ãƒ¶æœˆ
            </button>
            <button onclick="loadTechnicalChart('1Y')" class="period-btn px-3 py-1 rounded-lg text-sm font-medium transition-all duration-200 bg-gray-800/50 text-gray-400 hover:bg-purple-600/30 hover:text-purple-300">
                1å¹´
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div id="chart-loading" class="hidden text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"></div>
        <p class="text-gray-400 mt-4">ãƒãƒ£ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <!-- Error State -->
    <div id="chart-error" class="hidden bg-red-900/20 border border-red-500/30 rounded-lg p-4 text-red-300"></div>

    <!-- Premium Upgrade Prompt -->
    <div id="chart-premium-prompt" class="hidden bg-gradient-to-r from-amber-900/20 to-orange-900/20 border border-amber-500/30 rounded-lg p-6 text-center">
        <h4 class="text-lg font-bold text-amber-300 mb-3">â­ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³é™å®šæ©Ÿèƒ½</h4>
        <p class="text-gray-300 mb-4">ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æãƒãƒ£ãƒ¼ãƒˆã¯ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ä»¥ä¸Šã§ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™</p>
        <a href="/premium" class="inline-block px-6 py-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold rounded-lg hover:from-amber-600 hover:to-orange-600 transition-all duration-200">
            ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã‚’è¦‹ã‚‹
        </a>
    </div>

    <!-- Current Price Info -->
    <div id="price-info" class="hidden mb-6 grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-gray-800/50 rounded-lg p-3">
            <div class="text-xs text-gray-400 mb-1">ç¾åœ¨å€¤</div>
            <div id="current-price" class="text-lg font-bold text-white">-</div>
        </div>
        <div class="bg-gray-800/50 rounded-lg p-3">
            <div class="text-xs text-gray-400 mb-1">å¤‰åŒ–</div>
            <div id="price-change" class="text-lg font-bold">-</div>
        </div>
        <div class="bg-gray-800/50 rounded-lg p-3">
            <div class="text-xs text-gray-400 mb-1">RSI</div>
            <div id="rsi-value" class="text-lg font-bold text-purple-400">-</div>
        </div>
        <div class="bg-gray-800/50 rounded-lg p-3">
            <div class="text-xs text-gray-400 mb-1">25æ—¥MA</div>
            <div id="ma-value" class="text-lg font-bold text-orange-400">-</div>
        </div>
    </div>

    <!-- Chart Canvas -->
    <div id="chart-wrapper" class="hidden" style="height: 500px;">
        <canvas id="technical-chart"></canvas>
    </div>

    <!-- Indicator Legend -->
    <div id="indicator-legend" class="hidden mt-6 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
        <div class="bg-gray-800/30 rounded-lg p-3">
            <div class="font-semibold text-gray-300 mb-2">ğŸ“Š ä¾¡æ ¼æŒ‡æ¨™</div>
            <div class="space-y-1 text-xs">
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                    <span class="text-gray-400">æ ªä¾¡</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-orange-500"></span>
                    <span class="text-gray-400">ç§»å‹•å¹³å‡ç·š(25æ—¥)</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-purple-500"></span>
                    <span class="text-gray-400">ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰</span>
                </div>
            </div>
        </div>
        <div class="bg-gray-800/30 rounded-lg p-3">
            <div class="font-semibold text-gray-300 mb-2">â˜ï¸ ä¸€ç›®å‡è¡¡è¡¨</div>
            <div class="space-y-1 text-xs">
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-red-500"></span>
                    <span class="text-gray-400">è»¢æ›ç·š</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-green-500"></span>
                    <span class="text-gray-400">åŸºæº–ç·š</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 bg-gradient-to-r from-green-500/30 to-red-500/30 rounded"></span>
                    <span class="text-gray-400">é›²ï¼ˆå…ˆè¡Œã‚¹ãƒ‘ãƒ³A/Bï¼‰</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let technicalChartInstance = null;
const currentTicker = "{{ ticker }}"; // Passed from template context

function loadTechnicalChart(period = '3M') {
    const container = document.getElementById('technical-chart-container');
    const loading = document.getElementById('chart-loading');
    const error = document.getElementById('chart-error');
    const premiumPrompt = document.getElementById('chart-premium-prompt');
    const chartWrapper = document.getElementById('chart-wrapper');
    const priceInfo = document.getElementById('price-info');
    const legend = document.getElementById('indicator-legend');

    // Hide all states
    loading.classList.add('hidden');
    error.classList.add('hidden');
    premiumPrompt.classList.add('hidden');
    chartWrapper.classList.add('hidden');
    priceInfo.classList.add('hidden');
    legend.classList.add('hidden');

    // Show loading
    loading.classList.remove('hidden');

    // Update period button states
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.classList.remove('bg-purple-600/50', 'text-purple-200', 'border', 'border-purple-500/50');
        btn.classList.add('bg-gray-800/50', 'text-gray-400');
    });
    event?.target?.classList.remove('bg-gray-800/50', 'text-gray-400');
    event?.target?.classList.add('bg-purple-600/50', 'text-purple-200', 'border', 'border-purple-500/50');

    // Fetch chart data (include credentials for authentication)
    fetch(`/api/chart/technical?ticker=${encodeURIComponent(currentTicker)}&period=${period}`, {
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(data => {
            loading.classList.add('hidden');

            if (data.error === 'premium_required') {
                premiumPrompt.classList.remove('hidden');
                return;
            }

            if (data.error) {
                error.textContent = data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                error.classList.remove('hidden');
                return;
            }

            // Update price info
            document.getElementById('current-price').textContent = `Â¥${data.current_price.toLocaleString()}`;

            const changeElem = document.getElementById('price-change');
            const changeText = `${data.price_change >= 0 ? '+' : ''}${data.price_change.toFixed(2)} (${data.price_change_pct.toFixed(2)}%)`;
            changeElem.textContent = changeText;
            changeElem.className = `text-lg font-bold ${data.price_change >= 0 ? 'text-green-400' : 'text-red-400'}`;

            if (data.latest_values.rsi !== null) {
                const rsi = data.latest_values.rsi.toFixed(1);
                document.getElementById('rsi-value').textContent = rsi;
                const rsiElem = document.getElementById('rsi-value');
                rsiElem.className = `text-lg font-bold ${rsi > 70 ? 'text-red-400' : rsi < 30 ? 'text-green-400' : 'text-purple-400'}`;
            }

            if (data.latest_values.ma !== null) {
                document.getElementById('ma-value').textContent = `Â¥${data.latest_values.ma.toFixed(2)}`;
            }

            priceInfo.classList.remove('hidden');
            legend.classList.remove('hidden');

            // Render chart
            renderTechnicalChart(data.chart_data);
        })
        .catch(err => {
            loading.classList.add('hidden');
            error.textContent = `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${err.message}`;
            error.classList.remove('hidden');
        });
}

function renderTechnicalChart(chartData) {
    const ctx = document.getElementById('technical-chart').getContext('2d');
    const chartWrapper = document.getElementById('chart-wrapper');

    // Destroy existing chart
    if (technicalChartInstance) {
        technicalChartInstance.destroy();
    }

    chartWrapper.classList.remove('hidden');

    // Create new chart
    technicalChartInstance = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 12,
                        font: { size: 11 },
                        color: '#d1d5db',
                        filter: function(item) {
                            // Hide some labels to reduce clutter
                            return !item.text.includes('ã‚¹ãƒ‘ãƒ³');
                        }
                    }
                },
                tooltip: {
                    enabled: true,
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(17, 24, 39, 0.95)',
                    titleColor: '#f3f4f6',
                    bodyColor: '#d1d5db',
                    borderColor: '#6b7280',
                    borderWidth: 1
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'æ—¥ä»˜',
                        color: '#9ca3af'
                    },
                    ticks: {
                        maxTicksLimit: 12,
                        maxRotation: 45,
                        minRotation: 0,
                        color: '#9ca3af'
                    },
                    grid: {
                        color: 'rgba(107, 114, 128, 0.1)'
                    }
                },
                'y-price': {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'æ ªä¾¡ (å††)',
                        color: '#9ca3af'
                    },
                    ticks: {
                        color: '#9ca3af'
                    },
                    grid: {
                        color: 'rgba(107, 114, 128, 0.1)'
                    }
                },
                'y-rsi': {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'RSI',
                        color: '#9ca3af'
                    },
                    min: 0,
                    max: 100,
                    ticks: {
                        color: '#9ca3af',
                        stepSize: 20
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

// Auto-load chart on page load (3-month default)
document.addEventListener('DOMContentLoaded', function() {
    if (currentTicker) {
        loadTechnicalChart('3M');
    }
});
</script>
