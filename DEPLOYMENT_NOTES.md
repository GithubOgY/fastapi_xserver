# 運用・デプロイ備忘録

VPS環境における具体的な操作コマンドとトラブルシューティングの記録です。

## サーバー情報
- **OS**: Ubuntu 22.04
- **IP**: 162.43.40.229
- **作業ディレクトリ**: `/var/www/fastapi_xserver`

## よく使うコマンド集

### 更新作業のフロー
```bash
# 1. 権限エラーが出る場合は所有者を変更
sudo chown -R yukayohei:yukayohei /var/www/fastapi_xserver

# 2. 最新コードの取得
git pull

# 3. コンテナの再構築・起動
docker compose up -d --build
```

### ログの確認
```bash
# アプリのログ（Print文やエラーなど）
docker logs -f fastapi-app

# Nginxのアクセスログ・エラーログ
docker logs -f nginx-proxy
```

### 証明書の更新 (3ヶ月に1回)
Certbotが自動更新するように設定されていますが、手動で行う場合は以下：
```bash
docker compose down
sudo certbot renew
docker compose up -d
```

## トラブルシューティング
- **405 Method Not Allowed**: FastAPI で `methods=["GET", "HEAD"]` を明示的に許可する必要がある。
- **Permission Denied (git pull)**: `/var/www` ディレクトリの所有者が `root` になっている場合がある。`chown` で解決する。
- **接続拒否 (Connection Refused)**: ポート開放 (`docker-compose.yml`) と Nginx 内部のプロキシ先ポートが一致しているか確認。ブラウザが HTTPS に強制リダイレクトしていないか確認。

---

## プレミアム機能チャート - 最新デプロイメモ

### 修正内容 (2026-01-01)

#### 1. 管理者バッジ表示の修正
**ファイル**: `utils/premium.py` (195-217行目)

**問題**: 管理者ユーザーでログインしても FREE バッジが表示され続ける

**原因**: `get_tier_badge_html()` 関数が tier 文字列のみを受け取る仕様だったが、テンプレートから User オブジェクトが渡されていた

**解決策**: 関数を修正して User オブジェクトと文字列の両方を受け取れるように変更

```python
def get_tier_badge_html(user_or_tier) -> str:
    # User オブジェクトまたは tier 文字列を受け取る
    if isinstance(user_or_tier, str):
        tier = user_or_tier
    else:
        tier = get_user_tier(user_or_tier)
    # ... バッジHTMLを返す
```

#### 2. チャート自動スクロール機能の追加
**ファイル**: `templates/technical_chart_demo.html` (561-567行目)

**問題**: チャートは正常にレンダリングされているが、ページの下部に位置しているため表示されていないように見える

**解決策**: チャートが描画完了後に自動的にスクロールして表示領域に入るようにした

```javascript
// チャート描画後に自動スクロール
setTimeout(() => {
    const container = document.getElementById('technical-chart-container');
    if (container) {
        container.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}, 100);
```

#### 3. デバッグログの削除
**ファイル**: `templates/technical_chart_demo.html`

問題調査時に追加した console.log 文をすべて削除してクリーンなコードに戻した。

### デプロイ手順

```bash
# 1. 権限確認
sudo chown -R yukayohei:yukayohei /var/www/fastapi_xserver

# 2. 最新コードの取得
cd /var/www/fastapi_xserver
git pull

# 3. コンテナの再構築・起動
docker compose up -d --build

# 4. ログで起動確認
docker logs -f fastapi-app
```

### 動作確認項目

1. **管理者権限の確認**:
   - [ ] 管理者ユーザー (is_admin=1) でログイン
   - [ ] ユーザーバッジが「💎 ENTERPRISE」と表示される
   - [ ] テクニカルチャートが閲覧可能

2. **チャート表示**:
   - [ ] チャートが自動的にスクロールして表示される
   - [ ] テクニカル指標 (MA, ボリンジャーバンド, RSI, 一目均衡表) がすべて表示される
   - [ ] 期間切り替えボタン (1M, 3M, 6M, 1Y) が動作する

3. **プレミアム制限**:
   - [ ] 無料ユーザーにはプレミアムプラン案内が表示される
   - [ ] プレミアムユーザーはチャートが閲覧可能

### 管理者権限の付与方法

```bash
# データベースに直接接続
docker exec -it fastapi-app bash
sqlite3 xstock.db

# 管理者フラグを有効化
UPDATE users SET is_admin = 1 WHERE username = 'admin';
.exit
exit
```

### 修正ファイル一覧

1. `utils/premium.py` - バッジ HTML 生成関数の修正
2. `templates/technical_chart_demo.html` - 自動スクロール追加、デバッグログ削除
3. `main.py` - デバッグログ追加 (必要に応じて削除可能)

### 既知の問題

現在のところ、報告されていた問題はすべて解決済み:
- ✅ 管理者ユーザーに正しく ENTERPRISE バッジが表示される
- ✅ チャートが正常に表示される
- ✅ チャートが自動的にスクロール表示される
- ✅ プレミアムアップグレード案内が正しく動作する

---

## 財務指標計算ロジックの改善 (2026-01-01)

### 修正内容

#### 1. ROE/ROA計算の精度向上
**ファイル**: `utils/financial_analysis.py` (46-117行目)

**問題**:
- 期末時点の純資産/総資産のみを使用していた
- 期中の資産変動を考慮していなかった

**修正内容**:
```python
# 修正前
ROE = (当期純利益 / 純資産) × 100

# 修正後
ROE = (当期純利益 / ((期首純資産 + 期末純資産) / 2)) × 100
```

**理由**:
- 会計基準では期間平均を使用することが推奨される
- より実態に即した収益性指標となる
- 日本企業の有価証券報告書の計算方法と一致

#### 2. 総資産回転率の精度向上
**ファイル**: `utils/financial_analysis.py` (142-183行目)

**修正内容**:
```python
# 修正前
総資産回転率 = 売上高 / 総資産

# 修正後
総資産回転率 = 売上高 / ((期首総資産 + 期末総資産) / 2)
```

#### 3. 成長率計算のエッジケース対応
**ファイル**: `utils/financial_analysis.py` (12-86行目)

**追加した処理**:

| ケース | 前期 | 当期 | 処理 |
|--------|------|------|------|
| 黒字転換 | マイナス | プラス | 成長率=None, 備考「黒字転換」 |
| 赤字転落 | プラス | マイナス | 成長率=None, 備考「赤字転落」 |
| 両期赤字 | マイナス | マイナス | 成長率計算, 備考「両期とも赤字（解釈に注意）」 |
| 前期ゼロ | 0 | 任意 | 成長率=None, 備考「前期ゼロのため計算不可」 |
| 通常成長 | プラス | プラス | 標準の成長率計算 |

**例**:
```
前期営業利益: -200億円
当期営業利益: +500億円
→ 成長率: None, 備考: 黒字転換
```

#### 4. 計算方法の透明性向上

各指標に計算方法を明記:
- `ROE_計算方法`: 「期間平均」または「期末時点」
- `ROA_計算方法`: 「期間平均」または「期末時点」
- `総資産回転率_計算方法`: 「期間平均」または「期末時点」

前期データがない場合は自動的に期末時点で計算し、その旨を記録します。

### テスト結果

`test_financial_calculations.py` で以下のケースを検証:

1. ✅ ROE期間平均計算: 9.09% (期待値通り)
2. ✅ ROE期末時点計算: 8.33% (期待値通り)
3. ✅ 黒字転換の検出: 正常動作
4. ✅ 赤字転落の検出: 正常動作
5. ✅ 両期赤字の処理: 正常動作（警告付き）
6. ✅ 通常成長率計算: 25.0% (期待値通り)
7. ✅ 前期ゼロの処理: 正常動作
8. ✅ 総資産回転率: 1.72 (期待値通り)
9. ✅ トヨタ自動車想定データ: 全指標正常

### 影響を受ける機能

- AI銘柄分析の財務指標表示
- 銘柄比較機能のROE/ROA値
- 過去データとの成長率比較
- 財務健全性スコア計算

### 互換性

- **データベース**: 変更なし
- **API**: レスポンス構造は同じ（値の精度が向上）
- **UI**: 表示項目に計算方法の注記が追加される場合あり

### 注意事項

1. **前期データの重要性**
   - 2期以上のデータがある場合は期間平均で計算
   - 1期のみのデータでは期末時点で計算（その旨を明記）

2. **エッジケースの解釈**
   - 「黒字転換」「赤字転落」は成長率ではなく状態変化として扱う
   - 両期赤字の成長率は参考値として提供（警告付き）

3. **既存データへの影響**
   - 保存済みの分析結果は再計算されない
   - 新規分析から改善された計算方法が適用される

### 検証推奨

デプロイ後、以下を確認することを推奨:

1. トヨタ自動車 (7203) のROEが有価証券報告書と一致するか
2. ソフトバンクグループ (9984) のような赤字/黒字変動がある企業で適切な備考が表示されるか
3. 既存ユーザーの銘柄分析が正常に動作するか
