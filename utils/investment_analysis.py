"""
æŠ•è³‡åˆ¤æ–­åˆ†æé–¢æ•°
åŒ…æ‹¬çš„ãªæŠ•è³‡åˆ¤æ–­ã®ãŸã‚ã®åˆ†æãƒ­ã‚¸ãƒƒã‚¯
"""
import os
import logging
import markdown
from typing import Dict, Any
from utils.ai_analysis import setup_gemini, generate_with_fallback

logger = logging.getLogger(__name__)


def analyze_investment_decision(ticker_code: str, financial_context: Dict[str, Any], company_name: str = "") -> str:
    """
    ğŸ’ åŒ…æ‹¬çš„æŠ•è³‡åˆ¤æ–­åˆ†æ
    è²¡å‹™ãƒ»äº‹æ¥­ãƒ»ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒ»ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç·åˆçš„ã«è©•ä¾¡
    """
    from utils.yahoo_finance import get_investment_data

    model = setup_gemini()
    if not model:
        return "<p class='error' style='color: #fb7185;'>Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>"

    # Yahoo Financeã‹ã‚‰æŠ•è³‡åˆ¤æ–­ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    yahoo_data = get_investment_data(ticker_code)

    # EDINETãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¿…è¦ãªãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
    edinet_text = ""
    try:
        text_blocks = financial_context.get("edinet_data", {}).get("text_data", {})

        # æŠ•è³‡åˆ¤æ–­ã«å¿…è¦ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³
        analysis_keys = [
            "çµŒå–¶è€…ã«ã‚ˆã‚‹åˆ†æ",
            "è²¡æ”¿çŠ¶æ…‹ã®åˆ†æ",
            "çµŒå–¶æˆç¸¾ã®åˆ†æ",
            "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã®çŠ¶æ³",
            "äº‹æ¥­ã®å†…å®¹",
            "çµŒå–¶æ–¹é‡ãƒ»çµŒå–¶æˆ¦ç•¥",
            "ã‚³ãƒ¼ãƒãƒ¬ãƒ¼ãƒˆã‚¬ãƒãƒŠãƒ³ã‚¹",
            "äº‹æ¥­ç­‰ã®ãƒªã‚¹ã‚¯",
            "å¯¾å‡¦ã™ã¹ãèª²é¡Œ"
        ]

        for key in analysis_keys:
            if key in text_blocks and text_blocks[key]:
                # ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã«æ–‡å­—æ•°åˆ¶é™
                char_limit = {
                    "çµŒå–¶è€…ã«ã‚ˆã‚‹åˆ†æ": 3000,
                    "è²¡æ”¿çŠ¶æ…‹ã®åˆ†æ": 2000,
                    "çµŒå–¶æˆç¸¾ã®åˆ†æ": 2000,
                    "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã®çŠ¶æ³": 2000,
                    "äº‹æ¥­ã®å†…å®¹": 2000,
                    "çµŒå–¶æ–¹é‡ãƒ»çµŒå–¶æˆ¦ç•¥": 2500,
                    "ã‚³ãƒ¼ãƒãƒ¬ãƒ¼ãƒˆã‚¬ãƒãƒŠãƒ³ã‚¹": 2500,
                    "äº‹æ¥­ç­‰ã®ãƒªã‚¹ã‚¯": 1500,
                    "å¯¾å‡¦ã™ã¹ãèª²é¡Œ": 1500
                }.get(key, 2000)

                content = text_blocks[key][:char_limit]
                edinet_text += f"\n### {key}\n{content}\n"

    except Exception as e:
        logger.error(f"Failed to extract EDINET data: {e}")

    # Yahoo Financeãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢
    def format_value(val, fmt=""):
        if val is None:
            return "ãƒ‡ãƒ¼ã‚¿ãªã—"
        if isinstance(val, (int, float)):
            if fmt == "percent":
                return f"{val*100:.2f}%" if val < 1 else f"{val:.2f}%"
            elif fmt == "yen":
                return f"Â¥{val:,.0f}"
            elif fmt == "million":
                return f"{val/1_000_000:,.0f}ç™¾ä¸‡å††"
            elif fmt == "billion":
                return f"{val/1_000_000_000:,.2f}å„„å††"
            else:
                return f"{val:,.2f}"
        return str(val)

    yahoo_summary = f"""
ã€Så„ªå…ˆåº¦: ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã€‘
- æ ªä¾¡: {format_value(yahoo_data.get('æ ªä¾¡'), 'yen')}
- æ™‚ä¾¡ç·é¡: {format_value(yahoo_data.get('æ™‚ä¾¡ç·é¡'), 'billion')}
- PER: {format_value(yahoo_data.get('PER'))}å€
- PBR: {format_value(yahoo_data.get('PBR'))}å€

ã€Så„ªå…ˆåº¦: è³‡æœ¬åŠ¹ç‡ã€‘
- ROE: {format_value(yahoo_data.get('ROE'))}%
- ROA: {format_value(yahoo_data.get('ROA'))}%

ã€Aå„ªå…ˆåº¦: è²¡å‹™å¥å…¨æ€§ã€‘
- è‡ªå·±è³‡æœ¬æ¯”ç‡: {format_value(yahoo_data.get('è‡ªå·±è³‡æœ¬æ¯”ç‡'))}%
- ãƒãƒƒãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥: {format_value(yahoo_data.get('ãƒãƒƒãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥'), 'billion')}
- æœ‰åˆ©å­è² å‚µ: {format_value(yahoo_data.get('æœ‰åˆ©å­è² å‚µ'), 'billion')}

ã€Aå„ªå…ˆåº¦: æˆé•·æ€§ã€‘
- å£²ä¸Šæˆé•·ç‡: {format_value(yahoo_data.get('å£²ä¸Šæˆé•·ç‡'), 'percent')}
- åˆ©ç›Šæˆé•·ç‡: {format_value(yahoo_data.get('åˆ©ç›Šæˆé•·ç‡'), 'percent')}

ã€Bå„ªå…ˆåº¦: æ ªä¸»é‚„å…ƒã€‘
- é…å½“åˆ©å›ã‚Š: {format_value(yahoo_data.get('é…å½“åˆ©å›ã‚Š'), 'percent')}
- é…å½“æ€§å‘: {format_value(yahoo_data.get('é…å½“æ€§å‘'), 'percent')}

ã€å‚è€ƒæƒ…å ±ã€‘
- 52é€±é«˜å€¤/å®‰å€¤: {format_value(yahoo_data.get('52é€±é«˜å€¤'), 'yen')} / {format_value(yahoo_data.get('52é€±å®‰å€¤'), 'yen')}
- ã‚¢ãƒŠãƒªã‚¹ãƒˆç›®æ¨™æ ªä¾¡: {format_value(yahoo_data.get('ã‚¢ãƒŠãƒªã‚¹ãƒˆç›®æ¨™æ ªä¾¡'), 'yen')}
- å¾“æ¥­å“¡æ•°: {format_value(yahoo_data.get('å¾“æ¥­å“¡æ•°'), '')}äºº
- æ¥­ç¨®: {yahoo_data.get('æ¥­ç¨®', 'ãƒ‡ãƒ¼ã‚¿ãªã—')}
"""

    prompt = f"""
ã‚ãªãŸã¯çµŒé¨“è±Šå¯ŒãªæŠ•è³‡ã‚¢ãƒŠãƒªã‚¹ãƒˆã§ã™ã€‚
ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç·åˆçš„ã«åˆ†æã—ã€æŠ•è³‡åˆ¤æ–­ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

## å¯¾è±¡ä¼æ¥­
{company_name} ({ticker_code})

## å¸‚å ´ãƒ‡ãƒ¼ã‚¿ãƒ»ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆYahoo Financeï¼‰
{yahoo_summary}

## è²¡å‹™ãƒ‡ãƒ¼ã‚¿æ¦‚è¦ï¼ˆEDINETï¼‰
{financial_context.get('summary_text', 'è²¡å‹™ãƒ‡ãƒ¼ã‚¿ãªã—')}

## çµŒå–¶è€…ãƒ»ä¼æ¥­æƒ…å ±ï¼ˆEDINETè©³ç´°ï¼‰
{edinet_text if edinet_text else "EDINETãƒ‡ãƒ¼ã‚¿ãªã—"}

---

## åˆ†ææŒ‡ç¤º

ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰åŒ…æ‹¬çš„ã«è©•ä¾¡ã—ã€**æŠ•è³‡åˆ¤æ–­**ã‚’æ˜ç¢ºã«ç¤ºã—ã¦ãã ã•ã„ï¼š

### 1. ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æï¼ˆSå„ªå…ˆåº¦ï¼‰
- ç¾åœ¨ã®æ ªä¾¡æ°´æº–ã¯é©æ­£ã‹ï¼ˆPER/PBRåˆ†æï¼‰
- æ™‚ä¾¡ç·é¡ã¨äº‹æ¥­è¦æ¨¡ã®ãƒãƒ©ãƒ³ã‚¹
- éå»å¹³å‡ã‚„æ¥­ç•Œå¹³å‡ã¨ã®æ¯”è¼ƒ

### 2. åç›Šæ€§ãƒ»è³‡æœ¬åŠ¹ç‡ï¼ˆSå„ªå…ˆåº¦ï¼‰
- ROE/ROAã®æ°´æº–ã¨æŒç¶šå¯èƒ½æ€§
- å–¶æ¥­åˆ©ç›Šç‡ã®ãƒˆãƒ¬ãƒ³ãƒ‰
- è³‡æœ¬åŠ¹ç‡æ”¹å–„ã®å–ã‚Šçµ„ã¿

### 3. è²¡å‹™å¥å…¨æ€§ï¼ˆAå„ªå…ˆåº¦ï¼‰
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ï¼ˆå–¶æ¥­CFãƒ»ãƒ•ãƒªãƒ¼CFï¼‰ã®è³ª
- è‡ªå·±è³‡æœ¬æ¯”ç‡ã¨è² å‚µæ°´æº–
- ãƒãƒƒãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¸ã‚·ãƒ§ãƒ³

### 4. æˆé•·æ€§ãƒ»å°†æ¥æ€§ï¼ˆAå„ªå…ˆåº¦ï¼‰
- å£²ä¸Šãƒ»åˆ©ç›Šæˆé•·ç‡ã®ãƒˆãƒ¬ãƒ³ãƒ‰
- çµŒå–¶æˆ¦ç•¥ã®å®Ÿç¾å¯èƒ½æ€§
- å¸‚å ´æ©Ÿä¼šã¨ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°

### 5. äº‹æ¥­ç«¶äº‰åŠ›ï¼ˆAå„ªå…ˆåº¦ï¼‰
- ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«ã®æŒç¶šå¯èƒ½æ€§
- ç«¶äº‰å„ªä½æ€§ãƒ»å‚å…¥éšœå£
- ç ”ç©¶é–‹ç™ºãƒ»è¨­å‚™æŠ•è³‡ã®åŠ¹æœ

### 6. ãƒªã‚¹ã‚¯ãƒ»ã‚¬ãƒãƒŠãƒ³ã‚¹ï¼ˆBå„ªå…ˆåº¦ï¼‰
- ä¸»è¦ãƒªã‚¹ã‚¯è¦å› 
- ã‚³ãƒ¼ãƒãƒ¬ãƒ¼ãƒˆã‚¬ãƒãƒŠãƒ³ã‚¹ä½“åˆ¶
- çµŒå–¶é™£ã®è³ªã¨é€æ˜æ€§

### 7. æ ªä¸»é‚„å…ƒï¼ˆBå„ªå…ˆåº¦ï¼‰
- é…å½“åˆ©å›ã‚Šãƒ»é…å½“æ€§å‘
- æ ªä¸»é‚„å…ƒæ–¹é‡ã®æŒç¶šå¯èƒ½æ€§

---

## å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

ğŸ’ **ç·åˆè©•ä¾¡: [S/A/B/C/D]**
ğŸ¯ **æŠ•è³‡åˆ¤æ–­: [å¼·æ°—ã®è²·ã„/è²·ã„/ä¸­ç«‹/å£²ã‚Š/å¼·æ°—ã®å£²ã‚Š]**
ğŸ“Š **é©æ­£æ ªä¾¡ãƒ¬ãƒ³ã‚¸: Â¥XXX - Â¥XXX** ï¼ˆæ ¹æ‹ ã‚’æ˜è¨˜ï¼‰

### ğŸ“Š è©•ä¾¡ã‚µãƒãƒªãƒ¼ï¼ˆã‚¹ã‚³ã‚¢æ–¹å¼ï¼‰
- ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³: â­â­â­â­â˜† (4/5)
- åç›Šæ€§: â­â­â­â­â­ (5/5)
- è²¡å‹™å¥å…¨æ€§: â­â­â­â˜†â˜† (3/5)
- æˆé•·æ€§: â­â­â­â­â˜† (4/5)
- äº‹æ¥­ç«¶äº‰åŠ›: â­â­â­â­â˜† (4/5)
- æ ªä¸»é‚„å…ƒ: â­â­â­â˜†â˜† (3/5)

### âœ… æŠ•è³‡ã®å¼·ã¿ï¼ˆ3-5ç‚¹ï¼‰
1. ...
2. ...

### âš ï¸ æŠ•è³‡ã®ãƒªã‚¹ã‚¯ãƒ»æ‡¸å¿µç‚¹ï¼ˆ3-5ç‚¹ï¼‰
1. ...
2. ...

### ğŸ“ˆ è©³ç´°åˆ†æ

#### 1. ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
...

#### 2. åç›Šæ€§ãƒ»è³‡æœ¬åŠ¹ç‡
...

#### 3. è²¡å‹™å¥å…¨æ€§
...

#### 4. æˆé•·æˆ¦ç•¥
...

#### 5. äº‹æ¥­ç«¶äº‰åŠ›
...

#### 6. ãƒªã‚¹ã‚¯è©•ä¾¡
...

### ğŸ’¡ æŠ•è³‡å®¶ã¸ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹
æ˜ç¢ºãªæŠ•è³‡åˆ¤æ–­ã¨ã€ãã®ç†ç”±ã‚’3-5æ–‡ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
- çŸ­æœŸæŠ•è³‡å®¶å‘ã‘: ...
- é•·æœŸæŠ•è³‡å®¶å‘ã‘: ...
- ãƒªã‚¹ã‚¯è¨±å®¹åº¦åˆ¥: ...

---

## é‡è¦: è¨€èªæŒ‡å®š
**ã™ã¹ã¦ã®åˆ†æçµæœã¯å¿…ãšæ—¥æœ¬èªã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚**

åˆ†æçµæœã¯Markdownå½¢å¼ã§ã€ã™ã¹ã¦æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚

---
**å…è²¬äº‹é …:** æœ¬åˆ†æã¯å‚è€ƒæƒ…å ±ã§ã‚ã‚Šã€æŠ•è³‡ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æŠ•è³‡åˆ¤æ–­ã¯è‡ªå·±è²¬ä»»ã§è¡Œã£ã¦ãã ã•ã„ã€‚
"""

    try:
        api_key = os.getenv("GEMINI_API_KEY")
        model_name = os.getenv("GEMINI_MODEL", "gemini-2.0-flash")
        response_text = generate_with_fallback(prompt, api_key, model_name)
        return markdown.markdown(response_text, extensions=['extra', 'nl2br'])
    except Exception as e:
        logger.error(f"Investment analysis failed: {e}")
        return f"<p class='error' style='color: #fb7185;'>æŠ•è³‡åˆ¤æ–­åˆ†æã‚¨ãƒ©ãƒ¼: {str(e)}</p>"
