"""
æŠ•è³‡åˆ¤æ–­åˆ†æé–¢æ•°
åŒ…æ‹¬çš„ãªæŠ•è³‡åˆ¤æ–­ã®ãŸã‚ã®åˆ†æãƒ­ã‚¸ãƒƒã‚¯

ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å¤‰æ›´ã—ãŸã‚‰ INVESTMENT_PROMPT_VERSION ã‚’å¿…ãšæ›´æ–°ã™ã‚‹ã“ã¨ï¼
"""
import os
import logging
import markdown
from typing import Dict, Any
from utils.ai_analysis import setup_gemini, generate_with_fallback

logger = logging.getLogger(__name__)

# =========================================================
# æŠ•è³‡åˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
# - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¤‰æ›´æ™‚ã¯å¿…ãšã“ã®å€¤ã‚’æ›´æ–°ã™ã‚‹
# - ã“ã‚Œã«ã‚ˆã‚Šã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒè‡ªå‹•çš„ã«ç„¡åŠ¹åŒ–ã•ã‚Œã‚‹
# =========================================================
INVESTMENT_PROMPT_VERSION = "2026-01-04-v8-profit-ratio-analysis"


def analyze_investment_decision(ticker_code: str, financial_context: Dict[str, Any], company_name: str = "") -> str:
    """
    ğŸ’ åŒ…æ‹¬çš„æŠ•è³‡åˆ¤æ–­åˆ†æ
    è²¡å‹™ãƒ»äº‹æ¥­ãƒ»ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒ»ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç·åˆçš„ã«è©•ä¾¡
    """
    from utils.yahoo_finance import get_investment_data

    model = setup_gemini()
    if not model:
        return "<p class='error' style='color: #fb7185;'>Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>"

    # Yahoo Financeã‹ã‚‰æŠ•è³‡åˆ¤æ–­ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    yahoo_data = get_investment_data(ticker_code)

    # EDINETã®normalized_dataã‹ã‚‰PER/ROEã‚’å–å¾—ï¼ˆYahoo Financeã‚ˆã‚Šå„ªå…ˆï¼‰
    edinet_per = None
    edinet_roe = None
    edinet_pbr = None

    # financial_contextã‹ã‚‰ç›´æ¥normalized_dataã‚’å–å¾—
    if "PER" in financial_context:
        edinet_per = financial_context.get("PER")
    if "ROE" in financial_context:
        edinet_roe = financial_context.get("ROE")
        # EDINETã®ROEã¯å°æ•°å½¢å¼ï¼ˆ0.025 = 2.5%ï¼‰ãªã®ã§ã€ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆæ›ç®—
        if edinet_roe and edinet_roe < 1:
            edinet_roe = edinet_roe * 100
    if "PBR" in financial_context:
        edinet_pbr = financial_context.get("PBR")

    # EDINETãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€Yahoo Financeãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ã
    if edinet_per is not None:
        yahoo_data["PER"] = edinet_per
    if edinet_roe is not None:
        yahoo_data["ROE"] = edinet_roe
    if edinet_pbr is not None:
        yahoo_data["PBR"] = edinet_pbr

    # EDINETãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¿…è¦ãªãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
    edinet_text = ""
    try:
        text_blocks = financial_context.get("edinet_data", {}).get("text_data", {})

        # æŠ•è³‡åˆ¤æ–­ã«å¿…è¦ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³
        analysis_keys = [
            "çµŒå–¶è€…ã«ã‚ˆã‚‹åˆ†æ",
            "è²¡æ”¿çŠ¶æ…‹ã®åˆ†æ",
            "çµŒå–¶æˆç¸¾ã®åˆ†æ",
            "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã®çŠ¶æ³",
            "äº‹æ¥­ã®å†…å®¹",
            "çµŒå–¶æ–¹é‡ãƒ»çµŒå–¶æˆ¦ç•¥",
            "ã‚³ãƒ¼ãƒãƒ¬ãƒ¼ãƒˆã‚¬ãƒãƒŠãƒ³ã‚¹",
            "äº‹æ¥­ç­‰ã®ãƒªã‚¹ã‚¯",
            "å¯¾å‡¦ã™ã¹ãèª²é¡Œ"
        ]

        for key in analysis_keys:
            if key in text_blocks and text_blocks[key]:
                # ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã«æ–‡å­—æ•°åˆ¶é™
                char_limit = {
                    "çµŒå–¶è€…ã«ã‚ˆã‚‹åˆ†æ": 3000,
                    "è²¡æ”¿çŠ¶æ…‹ã®åˆ†æ": 2000,
                    "çµŒå–¶æˆç¸¾ã®åˆ†æ": 2000,
                    "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã®çŠ¶æ³": 2000,
                    "äº‹æ¥­ã®å†…å®¹": 2000,
                    "çµŒå–¶æ–¹é‡ãƒ»çµŒå–¶æˆ¦ç•¥": 2500,
                    "ã‚³ãƒ¼ãƒãƒ¬ãƒ¼ãƒˆã‚¬ãƒãƒŠãƒ³ã‚¹": 2500,
                    "äº‹æ¥­ç­‰ã®ãƒªã‚¹ã‚¯": 1500,
                    "å¯¾å‡¦ã™ã¹ãèª²é¡Œ": 1500
                }.get(key, 2000)

                content = text_blocks[key][:char_limit]
                edinet_text += f"\n### {key}\n{content}\n"

    except Exception as e:
        logger.error(f"Failed to extract EDINET data: {e}")

    # Yahoo Financeãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢
    def format_value(val, fmt=""):
        if val is None:
            return "ãƒ‡ãƒ¼ã‚¿ãªã—"
        if isinstance(val, (int, float)):
            if fmt == "percent":
                return f"{val*100:.2f}%" if val < 1 else f"{val:.2f}%"
            elif fmt == "yen":
                return f"Â¥{val:,.0f}"
            elif fmt == "million":
                return f"{val/1_000_000:,.0f}ç™¾ä¸‡å††"
            elif fmt == "billion":
                # å„„å†† = 100,000,000å††ï¼ˆ1å„„å††ï¼‰
                return f"{val/100_000_000:,.2f}å„„å††"
            else:
                return f"{val:,.2f}"
        return str(val)

    # æ ªä¾¡å¤‰å‹•ã®è¨ˆç®—
    current_price = yahoo_data.get('æ ªä¾¡')
    prev_close = yahoo_data.get('å‰æ—¥çµ‚å€¤')
    price_change = None
    price_change_pct = None
    if current_price and prev_close and prev_close > 0:
        price_change = current_price - prev_close
        price_change_pct = (price_change / prev_close) * 100

    yahoo_summary = f"""
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ ã€é‡è¦ã€‘Yahoo Finance ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**ä»¥ä¸‹ã®Yahoo Financeãƒ‡ãƒ¼ã‚¿ã«ã¯å¤ã„æ±ºç®—ãƒ‡ãƒ¼ã‚¿ã‚„ä¸æ­£ç¢ºãªå€¤ãŒæ··åœ¨ã—ã¦ã„ã¾ã™ã€‚**
**æ™‚ä¾¡ç·é¡ãƒ»PERãƒ»ROEãªã©ã®è²¡å‹™æŒ‡æ¨™ã¯ã€EDINETã®å…¬å¼ãƒ‡ãƒ¼ã‚¿ã¨å¤§ããä¹–é›¢ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚**

**ã€ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ãƒ«ãƒ¼ãƒ«ã€‘**
1. âœ… æ ªä¾¡æƒ…å ±ï¼ˆç¾åœ¨æ ªä¾¡ãƒ»å‰æ—¥çµ‚å€¤ãƒ»å¤‰å‹•ï¼‰â†’ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã®ãŸã‚ä¿¡é ¼æ€§é«˜
2. âš ï¸ ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ™‚ä¾¡ç·é¡ãƒ»PERï¼‰â†’ å¤ã„æ±ºç®—ãƒ™ãƒ¼ã‚¹ã®å¯èƒ½æ€§ã‚ã‚Š
3. âš ï¸ è²¡å‹™æŒ‡æ¨™ï¼ˆROEãƒ»ROAï¼‰â†’ EDINETãƒ‡ãƒ¼ã‚¿ã¨å¿…ãšç…§åˆã™ã‚‹ã“ã¨
4. âœ… ã‚¢ãƒŠãƒªã‚¹ãƒˆæƒ…å ±ãƒ»52é€±é«˜å€¤å®‰å€¤ â†’ å‚è€ƒå€¤ã¨ã—ã¦ä½¿ç”¨å¯

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€æ ªä¾¡æƒ…å ±ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰âœ… ä¿¡é ¼æ€§é«˜ã€‘
- ç¾åœ¨æ ªä¾¡: {format_value(yahoo_data.get('æ ªä¾¡'), 'yen')}
- å‰æ—¥çµ‚å€¤: {format_value(yahoo_data.get('å‰æ—¥çµ‚å€¤'), 'yen')}
- å¤‰å‹•: {format_value(price_change, 'yen') if price_change is not None else 'ãƒ‡ãƒ¼ã‚¿ãªã—'} ({f'+{price_change_pct:.2f}%' if price_change_pct and price_change_pct >= 0 else f'{price_change_pct:.2f}%' if price_change_pct else 'ãƒ‡ãƒ¼ã‚¿ãªã—'})

ã€ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã€‘
- æ™‚ä¾¡ç·é¡: {format_value(yahoo_data.get('æ™‚ä¾¡ç·é¡'), 'billion')}
  âš ï¸ è­¦å‘Š: Yahoo Financeã®å€¤ã¯å¤ã„å¯èƒ½æ€§ã‚ã‚Š
- PER: {format_value(yahoo_data.get('PER'))}å€
  {'âœ… EDINETãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼ˆä¿¡é ¼æ€§é«˜ï¼‰' if edinet_per is not None else 'âš ï¸ Yahoo Financeäºˆæƒ³PERï¼ˆè¦æ³¨æ„ï¼‰'}
- PBR: {format_value(yahoo_data.get('PBR'))}å€
  {'âœ… EDINETãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼ˆä¿¡é ¼æ€§é«˜ï¼‰' if edinet_pbr is not None else ''}

ã€è³‡æœ¬åŠ¹ç‡ã€‘
- ROE: {format_value(yahoo_data.get('ROE'))}%
  {'âœ… EDINETãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼ˆä¿¡é ¼æ€§é«˜ï¼‰' if edinet_roe is not None else 'âš ï¸ Yahoo Financeãƒ‡ãƒ¼ã‚¿ï¼ˆè¦æ¤œè¨¼ï¼‰'}
- ROA: {format_value(yahoo_data.get('ROA'))}% âš ï¸ Yahoo Financeãƒ‡ãƒ¼ã‚¿ï¼ˆå‚è€ƒå€¤ï¼‰

ã€è²¡å‹™å¥å…¨æ€§ï¼ˆå‚è€ƒå€¤ãƒ»è¦æ¤œè¨¼ï¼‰ã€‘
- è‡ªå·±è³‡æœ¬æ¯”ç‡: {format_value(yahoo_data.get('è‡ªå·±è³‡æœ¬æ¯”ç‡'))}%
- ãƒãƒƒãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥: {format_value(yahoo_data.get('ãƒãƒƒãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥'), 'billion')} âš ï¸ è¦æ¤œè¨¼
- æœ‰åˆ©å­è² å‚µ: {format_value(yahoo_data.get('æœ‰åˆ©å­è² å‚µ'), 'billion')} âš ï¸ è¦æ¤œè¨¼

ã€æˆé•·æ€§ï¼ˆå‚è€ƒå€¤ï¼‰ã€‘
- å£²ä¸Šæˆé•·ç‡: {format_value(yahoo_data.get('å£²ä¸Šæˆé•·ç‡'), 'percent')}
- åˆ©ç›Šæˆé•·ç‡: {format_value(yahoo_data.get('åˆ©ç›Šæˆé•·ç‡'), 'percent')}

ã€æ ªä¸»é‚„å…ƒã€‘
- é…å½“åˆ©å›ã‚Š: {format_value(yahoo_data.get('é…å½“åˆ©å›ã‚Š'), 'percent')}
- é…å½“é‡‘é¡: {format_value(yahoo_data.get('é…å½“é‡‘é¡'), 'yen')}
- é…å½“æ€§å‘: {format_value(yahoo_data.get('é…å½“æ€§å‘'), 'percent')}

ã€å‚è€ƒæƒ…å ±ã€‘
- 52é€±é«˜å€¤/å®‰å€¤: {format_value(yahoo_data.get('52é€±é«˜å€¤'), 'yen')} / {format_value(yahoo_data.get('52é€±å®‰å€¤'), 'yen')}
- ã‚¢ãƒŠãƒªã‚¹ãƒˆç›®æ¨™æ ªä¾¡: {format_value(yahoo_data.get('ã‚¢ãƒŠãƒªã‚¹ãƒˆç›®æ¨™æ ªä¾¡'), 'yen')}
- æ¥­ç¨®: {yahoo_data.get('æ¥­ç¨®', 'ãƒ‡ãƒ¼ã‚¿ãªã—')}
"""

    # =====================================================
    # æ ªä¸»æ§‹æˆãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢
    # =====================================================
    shareholder_summary = ""
    shareholder_data = financial_context.get("edinet_data", {}).get("shareholder_data", [])
    
    if shareholder_data:
        shareholder_lines = ["ã€å¤§æ ªä¸»ã®çŠ¶æ³ã€‘EDINETå…¬å¼ãƒ‡ãƒ¼ã‚¿"]
        shareholder_lines.append("| é †ä½ | æ ªä¸»å | æ‰€æœ‰æ ªå¼æ•° | æŒæ ªæ¯”ç‡ |")
        shareholder_lines.append("|------|--------|------------|----------|")
        
        total_ratio = 0.0
        for i, sh in enumerate(shareholder_data[:10], 1):  # ä¸Šä½10ä½ã¾ã§è¡¨ç¤º
            name = sh.get("name", "")
            shares = sh.get("shares", 0)
            ratio = sh.get("ratio", 0.0)
            total_ratio += ratio
            
            # æ ªå¼æ•°ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆä¸‡æ ª/åƒæ ªå˜ä½ã§è¡¨ç¤ºï¼‰
            if shares >= 10000:
                shares_str = f"{shares / 10000:,.1f}ä¸‡æ ª"
            elif shares >= 1000:
                shares_str = f"{shares / 1000:,.1f}åƒæ ª"
            else:
                shares_str = f"{shares:,}æ ª"
            
            shareholder_lines.append(f"| {i} | {name} | {shares_str} | {ratio:.2f}% |")
        
        shareholder_lines.append(f"\n**ä¸Šä½{len(shareholder_data[:10])}ä½åˆè¨ˆæŒæ ªæ¯”ç‡: {total_ratio:.2f}%**")
        
        # æ ªä¸»æ§‹æˆã®ç‰¹å¾´åˆ†æãƒ¡ãƒ¢ã‚’è¿½åŠ 
        shareholder_lines.append("\nã€æ ªä¸»æ§‹æˆã®ç‰¹å¾´ï¼ˆåˆ†ææ™‚ã®å‚è€ƒï¼‰ã€‘")
        
        # æ©Ÿé–¢æŠ•è³‡å®¶ãƒ»ä¿¡è¨—éŠ€è¡Œã®å‰²åˆãƒã‚§ãƒƒã‚¯
        institutional_keywords = ["ä¿¡è¨—éŠ€è¡Œ", "ä¿¡è¨—å£", "ãƒã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¹ãƒˆ", "ã‚«ã‚¹ãƒˆãƒ‡ã‚£", "TRUSTEE", "CUSTODY"]
        institutional_ratio = sum(sh.get("ratio", 0) for sh in shareholder_data if any(kw in sh.get("name", "") for kw in institutional_keywords))
        if institutional_ratio > 0:
            shareholder_lines.append(f"- æ©Ÿé–¢æŠ•è³‡å®¶ï¼ˆä¿¡è¨—å£ï¼‰æ¨å®šæ¯”ç‡: {institutional_ratio:.1f}%")
        
        # å‰µæ¥­å®¶ãƒ»çµŒå–¶è€…ä¿æœ‰ãƒã‚§ãƒƒã‚¯ï¼ˆå˜ç´”ãªæ¨æ¸¬ç”¨ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
        shareholder_lines.append("- â€» å‰µæ¥­å®¶ãƒ»çµŒå–¶è€…ã®æŒåˆ†ã¯æœ‰ä¾¡è¨¼åˆ¸å ±å‘Šæ›¸ã®ã€Œå½¹å“¡ã®çŠ¶æ³ã€ã‚’å‚ç…§")
        
        shareholder_summary = "\n".join(shareholder_lines)
    else:
        shareholder_summary = "ã€å¤§æ ªä¸»ã®çŠ¶æ³ã€‘ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆEDINETã‹ã‚‰å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰"

    # =====================================================
    # å¾“æ¥­å“¡ç”Ÿç”£æ€§ãƒ»äººçš„è³‡æœ¬åˆ†æãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢
    # =====================================================
    employee_summary = ""
    normalized_data = financial_context.get("edinet_data", {}).get("normalized_data", {})
    
    emp_count = normalized_data.get("å¾“æ¥­å“¡æ•°")
    avg_salary = normalized_data.get("å¹³å‡å¹´å")
    
    # è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼ˆå˜ä½: å††ï¼‰
    revenue = normalized_data.get("å£²ä¸Šé«˜")
    op_income = normalized_data.get("å–¶æ¥­åˆ©ç›Š")
    net_income = normalized_data.get("å½“æœŸç´”åˆ©ç›Š")
    
    if emp_count and emp_count > 0 and avg_salary:
        productivity_lines = ["ã€å¾“æ¥­å“¡ç”Ÿç”£æ€§åˆ†æã€‘(EDINETãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãè¨ˆç®—å€¤)"]
        
        # 1. ä¸€äººå½“ãŸã‚ŠæŒ‡æ¨™ã®è¨ˆç®—ï¼ˆå…¨ã¦å††å˜ä½ï¼‰
        rev_per_emp = revenue / emp_count if revenue else 0
        op_per_emp = op_income / emp_count if op_income else 0
        net_per_emp = net_income / emp_count if net_income else 0
        
        # 2. çµ¦ä¸å¯¾æ¯”ã®ç”Ÿç”£æ€§ï¼ˆåŠ´åƒåˆ†é…ç‡ã®é€†æ•°çš„ãªè¦–ç‚¹ï¼‰
        # å¾“æ¥­å“¡ä¸€äººå½“ãŸã‚Šå–¶æ¥­åˆ©ç›Š - å¹³å‡å¹´å
        profit_salary_gap = op_per_emp - avg_salary
        # çµ¦ä¸å€ç‡ï¼ˆå–¶æ¥­åˆ©ç›Šãƒ™ãƒ¼ã‚¹ï¼‰
        profit_salary_ratio = op_per_emp / avg_salary if avg_salary > 0 else 0
        
        # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
        def fmt_yen(val):
            return f"Â¥{val:,.0f}"
            
        def fmt_man(val):
            return f"{val/10000:,.0f}ä¸‡å††"
        
        productivity_lines.append(f"- å¾“æ¥­å“¡æ•°: {emp_count:,}äºº")
        productivity_lines.append(f"- å¹³å‡å¹´å: {fmt_man(avg_salary)} ({fmt_yen(avg_salary)})")
        productivity_lines.append("")
        productivity_lines.append("**ç”Ÿç”£æ€§æŒ‡æ¨™ï¼ˆä¸€äººå½“ãŸã‚Šï¼‰:**")
        productivity_lines.append(f"- å£²ä¸Šé«˜: {fmt_man(rev_per_emp)}")
        productivity_lines.append(f"- å–¶æ¥­åˆ©ç›Š: {fmt_man(op_per_emp)}")
        productivity_lines.append(f"- å½“æœŸç´”åˆ©ç›Š: {fmt_man(net_per_emp)}")
        productivity_lines.append("")
        productivity_lines.append("**äººçš„è³‡æœ¬ROIåˆ†æ:**")
        productivity_lines.append(f"- çµ¦ä¸å€ç‡ (å£²ä¸Š/çµ¦ä¸): {rev_per_emp/avg_salary:.2f}å€")
        productivity_lines.append(f"- åˆ©ç›Šå€ç‡ (å–¶æ¥­åˆ©ç›Š/çµ¦ä¸): {profit_salary_ratio:.2f}å€")
        
        # åˆ¤å®šã‚³ãƒ¡ãƒ³ãƒˆ
        if op_per_emp > avg_salary:
            productivity_lines.append(f"- âœ… **é»’å­—æ§‹é€ **: çµ¦ä¸ã®{profit_salary_ratio:.2f}å€ã®åˆ©ç›Šã‚’ç¨¼ã„ã§ã„ã‚‹ (+{fmt_man(profit_salary_gap)})")
        elif op_per_emp > 0:
            productivity_lines.append(f"- âš ï¸ **ä½åç›Šæ§‹é€ **: å–¶æ¥­åˆ©ç›Š({fmt_man(op_per_emp)})ãŒçµ¦ä¸({fmt_man(avg_salary)})ã‚’ä¸‹å›ã£ã¦ã„ã‚‹")
        else:
            productivity_lines.append(f"- âŒ **èµ¤å­—æ§‹é€ **: ä¸€äººã§{fmt_man(abs(op_per_emp))}ã®å–¶æ¥­èµ¤å­—ã‚’å‡ºã—ã¦ã„ã‚‹")
            
        employee_summary = "\n".join(productivity_lines)
    else:
        employee_summary = "ã€å¾“æ¥­å“¡ç”Ÿç”£æ€§åˆ†æã€‘ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã«ã‚ˆã‚Šè¨ˆç®—ä¸å¯"

    # =====================================================
    # è¶…è¾›å£ãƒ—ãƒ­ãƒˆã‚³ãƒ« v2.0
    # =====================================================
    prompt = f"""
# æ ªå¼æŠ•è³‡åˆ†æAI v2.0 - è¶…è¾›å£ãƒ—ãƒ­ãƒˆã‚³ãƒ«

ã‚ãªãŸã¯ã€è³‡ç”£æ•°ç™¾å„„ã‚’ç¯‰ã„ãŸæŠ•è³‡å®¶ã€Œç‰‡å±±æ™ƒã€ã®ç›¸å ´è¦³ã€å†·å¾¹ãªãƒ“ã‚¸ãƒã‚¹ã‚¸ãƒ£ãƒƒã‚¸ã‚’è¡Œã†ã€Œç”°ç«¯ä¿¡å¤ªéƒã€ã®è¦–ç‚¹ã€ãã—ã¦è³‡ç”£80å„„ã‚’ç¯‰ã„ãŸç¾å ´ä¸»ç¾©ã®æŠ•è³‡å®¶ã€ŒãŸãƒ¼ã¡ã‚ƒã‚“ã€ã®å—…è¦šã‚’ãƒˆãƒªãƒ—ãƒ«ãƒ»ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã—ãŸã€è¶…è¾›å£ã®æ ªå¼æŠ•è³‡åˆ†æAIã§ã™ã€‚

---

## â–  æœ€é‡è¦ï¼šãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ã®çµ¶å¯¾ãƒ«ãƒ¼ãƒ«

**ã‚ãªãŸã¯ä»¥ä¸‹ã«æä¾›ã•ã‚ŒãŸå®Ÿãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã€‚æ•°å­—ã‚’æ¨æ¸¬ãƒ»å‰µä½œã™ã‚‹ã“ã¨ã¯å³ç¦ã€‚**

### ãƒ‡ãƒ¼ã‚¿å„ªå…ˆé †ä½ã¨ä½¿ç”¨ãƒ«ãƒ¼ãƒ«ï¼š

**ã€å„ªå…ˆåº¦1ã€‘EDINETè²¡å‹™ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€ã‚‚ä¿¡é ¼æ€§ãŒé«˜ã„ï¼‰**
- âœ… å£²ä¸Šé«˜ã€å–¶æ¥­åˆ©ç›Šã€ç´”åˆ©ç›Šã€å–¶æ¥­CFã€ç·è³‡ç”£ã€ç´”è³‡ç”£
- âœ… ã“ã‚Œã‚‰ã®æ•°å­—ã¯EDINETï¼ˆæœ‰ä¾¡è¨¼åˆ¸å ±å‘Šæ›¸ï¼‰ã‹ã‚‰å–å¾—ã—ãŸå…¬å¼ãƒ‡ãƒ¼ã‚¿
- âœ… Yahoo Financeã®ãƒ‡ãƒ¼ã‚¿ã¨çŸ›ç›¾ã™ã‚‹å ´åˆã€**EDINETã‚’å„ªå…ˆ**ã™ã‚‹ã“ã¨

**ã€å„ªå…ˆåº¦2ã€‘Yahoo Financeå¸‚å ´ãƒ‡ãƒ¼ã‚¿ï¼ˆå‚è€ƒå€¤ã¨ã—ã¦ä½¿ç”¨ï¼‰**
- âš ï¸ æ ªä¾¡ã€PERã€PBRã€ROEãªã©ã¯**å‚è€ƒå€¤**ã¨ã—ã¦æ‰±ã†
- âš ï¸ Yahoo Financeã®ãƒ‡ãƒ¼ã‚¿ã«ã¯**å¤ã„æ±ºç®—ãƒ‡ãƒ¼ã‚¿ãŒæ··åœ¨ã™ã‚‹å¯èƒ½æ€§**ãŒã‚ã‚‹
- âš ï¸ æ™‚ä¾¡ç·é¡ã¯ã€Œæ ªä¾¡ Ã— ç™ºè¡Œæ¸ˆæ ªå¼æ•°ã€ã§è‡ªåˆ†ã§è¨ˆç®—ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨
- âš ï¸ ROEãŒãƒã‚¤ãƒŠã‚¹ãªã®ã«PERãŒå­˜åœ¨ã™ã‚‹å ´åˆã€**ãƒ‡ãƒ¼ã‚¿ã®çŸ›ç›¾**ã‚’æŒ‡æ‘˜ã™ã‚‹ã“ã¨

**ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å¿…é ˆã€‘**
- PER > 0 ãªã‚‰åˆ©ç›Šã¯é»’å­—ã®ã¯ãš â†’ ROEãŒãƒã‚¤ãƒŠã‚¹ãªã‚‰çŸ›ç›¾
- PBR Ã— ROE â‰’ PER ã®é–¢ä¿‚ãŒæˆç«‹ã™ã‚‹ã‹ç¢ºèª
- çŸ›ç›¾ãŒã‚ã‚‹å ´åˆã¯ã€Œ**Yahoo Financeã®ãƒ‡ãƒ¼ã‚¿ã«çŸ›ç›¾ãŒã‚ã‚Šã¾ã™ã€‚EDINETãƒ‡ãƒ¼ã‚¿ã‚’å„ªå…ˆã—ã¾ã™**ã€ã¨æ˜è¨˜

**ã€æ•°å€¤æ¯”è¼ƒã¨ä¸ç­‰å·ã®æ­£ç¢ºæ€§ï¼ˆè¶…é‡è¦ï¼‰ã€‘**
- âŒ **çµ¶å¯¾ç¦æ­¢**: ã€Œ1,000å„„å†† ï¼ 4,800å„„å††ã€ã®ã‚ˆã†ãªè«–ç†çš„ã«èª¤ã£ãŸä¸ç­‰å·ã®ä½¿ç”¨
- âœ… **å¿…é ˆ**: æ•°å€¤ã‚’æ¯”è¼ƒã™ã‚‹éš›ã¯ã€å¿…ãšå¤§å°é–¢ä¿‚ã‚’æ­£ã—ãç¢ºèªã™ã‚‹ã“ã¨
  - ä¾‹: 1,000å„„å†† < 4,800å„„å††ï¼ˆ1,000ã¯4,800ã‚ˆã‚Š**å°ã•ã„**ï¼‰
  - ä¾‹: æ™‚ä¾¡ç·é¡4,800å„„å†† > ç¾é‡‘1,000å„„å††ï¼ˆ4,800ã¯1,000ã‚ˆã‚Š**å¤§ãã„**ï¼‰
- âœ… **å¿…é ˆ**: ä¸ç­‰å·ã‚’æ›¸ãå‰ã«ã€å·¦è¾ºã¨å³è¾ºã®æ•°å€¤ã‚’å¿…ãšå†ç¢ºèªã™ã‚‹ã“ã¨
- âš ï¸ ä¸ç­‰å·ã®é–“é•ã„ã¯ã€åˆ†æå…¨ä½“ã®ä¿¡é ¼æ€§ã‚’å®Œå…¨ã«å¤±ã‚ã›ã‚‹è‡´å‘½çš„ãªãƒŸã‚¹ã§ã‚ã‚‹

**ã€çµ¶å¯¾ç¦æ­¢ã€‘**
- âŒ ãƒ‡ãƒ¼ã‚¿ãŒãªã„é …ç›®ã«ã¤ã„ã¦æ•°å­—ã‚’æ¨æ¸¬ãƒ»å‰µä½œã™ã‚‹ã“ã¨
- âŒ ã€Œã‚»ã‚¯ã‚¿ãƒ¼å¹³å‡PERã€ãªã©ã€æä¾›ã•ã‚Œã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿ã‚’å‹æ‰‹ã«ä»®å®šã™ã‚‹ã“ã¨
- âŒ çŸ›ç›¾ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾ä½¿ç”¨ã™ã‚‹ã“ã¨
- âŒ æ•°å€¤ã®å¤§å°é–¢ä¿‚ã‚’é–“é•ãˆãŸä¸ç­‰å·ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨

**ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆï¼š**
- ã€Œã“ã®ãƒ‡ãƒ¼ã‚¿ã¯å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€ã¨æ˜è¨˜ã™ã‚‹
- ä¸è¶³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹é …ç›®ã¯åˆ¤å®šã‚’ä¿ç•™ã™ã‚‹ã‹ã€ã€Œãƒ‡ãƒ¼ã‚¿ä¸è¶³ã«ã‚ˆã‚Šåˆ¤å®šä¸èƒ½ã€ã¨è¨˜è¼‰ã™ã‚‹
- çµ¶å¯¾ã«æ•°å­—ã‚’å‰µä½œã—ã¦ã¯ã„ã‘ãªã„

---

## â–  çµ¶å¯¾éµå®ˆäº‹é …ï¼ˆã“ã‚Œã‚’ç ´ã£ãŸã‚‰åˆ†æã¯ç„¡åŠ¹ï¼‰

### 1. å¼·åˆ¶åˆ¤å®šãƒ«ãƒ¼ãƒ«ï¼ˆä¾‹å¤–ãªã—ï¼‰

ä»¥ä¸‹ã®æ¡ä»¶ã«**1ã¤ã§ã‚‚è©²å½“**ã™ã‚‹å ´åˆã€è‡ªå‹•çš„ã«æŒ‡å®šãƒ©ãƒ³ã‚¯ä»¥ä¸‹ã¨ã™ã‚‹ã€‚
AIã®ã€Œç·åˆåˆ¤æ–­ã€ã§ã“ã‚Œã‚’è¦†ã™ã“ã¨ã¯**ç¦æ­¢**ã€‚

| æ¡ä»¶ | å¼·åˆ¶åˆ¤å®š | ç†ç”± |
|------|---------|------|
| ROE < 5% ã‹ã¤ PBR < 1.0 | **Cä»¥ä¸‹ç¢ºå®š** | ãƒãƒªãƒ¥ãƒ¼ãƒˆãƒ©ãƒƒãƒ—ã®å…¸å‹ãƒ‘ã‚¿ãƒ¼ãƒ³ |
| ROE < æ ªä¸»è³‡æœ¬ã‚³ã‚¹ãƒˆ(8%) | **Bä»¥ä¸‹ç¢ºå®š** | ä¾¡å€¤ç ´å£Šä¼æ¥­ |
| å£²ä¸Šæˆé•·ç‡ > +35% | **Bä»¥ä¸‹ç¢ºå®š** | é€Ÿåº¦é•åï¼ˆçµ„ç¹”å´©å£Šãƒªã‚¹ã‚¯ï¼‰ |
| å£²ä¸Šæˆé•·ç‡ < +5%ï¼ˆéãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚·ãƒ–ï¼‰ | **Bä»¥ä¸‹ç¢ºå®š** | ã‚¤ãƒ³ãƒ•ãƒ¬è² ã‘ |
| å–¶æ¥­CF < 0 | **Dç¢ºå®š** | åˆ©ç›Šã®è³ªãŒå´©å£Š |
| å–¶æ¥­åˆ©ç›Šå¢—åŠ ç‡ < å£²ä¸Šå¢—åŠ ç‡ã®åŠåˆ† | **Bä»¥ä¸‹ç¢ºå®š** | åˆ©ç›Šç‡æ‚ªåŒ– |
| ã‚·ã‚¯ãƒªã‚«ãƒ«éŠ˜æŸ„ã§æœ€é«˜ç›Šæ›´æ–°ä¸­ | **Cä»¥ä¸‹ç¢ºå®š** | ã‚µã‚¤ã‚¯ãƒ«ã®å¤©äº•ãƒªã‚¹ã‚¯ |
| æœ‰åˆ©å­è² å‚µ > ç´”è³‡ç”£ | **Cä»¥ä¸‹ç¢ºå®š** | è²¡å‹™ãƒªã‚¹ã‚¯ |

### 2. ç¦æ­¢è¡¨ç¾ãƒªã‚¹ãƒˆ

ä»¥ä¸‹ã®æ›–æ˜§ãªè¡¨ç¾ã¯**ä½¿ç”¨ç¦æ­¢**ï¼š
- âŒ ç¦æ­¢: ã€Œé­…åŠ›çš„ã€ã€ŒæœŸå¾…ã§ãã‚‹ã€ã€Œãƒã‚¸ãƒ†ã‚£ãƒ–ã€ã€Œè‰¯å¥½ã€ã€Œå¥å…¨ã€
- âŒ ç¦æ­¢: ã€Œä¸€å®šã®è©•ä¾¡ãŒã§ãã‚‹ã€ã€Œæ¨™æº–çš„ãªæ°´æº–ã€ã€ŒæŠ•è³‡å¦™å‘³ãŒã‚ã‚‹ã€
- âŒ ç¦æ­¢: ã€Œå°†æ¥çš„ã«ã¯æœŸå¾…ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€
- âŒ ç¦æ­¢: ã€Œç·åˆçš„ã«åˆ¤æ–­ã™ã‚‹ã¨ã€ï¼ˆå…·ä½“æ€§ãªã—ã§ä½¿ç”¨ã™ã‚‹å ´åˆï¼‰

ä»£ã‚ã‚Šã«ä½¿ã†ã¹ãè¡¨ç¾ï¼š
- âœ… æ¨å¥¨: ã€ŒROEâ—‹%ã¯æ ªä¸»è³‡æœ¬ã‚³ã‚¹ãƒˆ8%ã‚’ä¸‹å›ã£ã¦ãŠã‚Šã€ä¾¡å€¤ç ´å£Šä¼æ¥­ã§ã‚ã‚‹ã€
- âœ… æ¨å¥¨: ã€Œå£²ä¸Š+â—‹%ã¯é€Ÿåº¦é•åã§ã‚ã‚Šã€æ¥æœŸã®åå‹•æ¸›ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã€
- âœ… æ¨å¥¨: ã€ŒPBRâ—‹å€ã¯ROEâ—‹%ã‚’è€ƒæ…®ã™ã‚‹ã¨æ­£å½“ãªè©•ä¾¡ã§ã‚ã‚Šã€å‰²å®‰ã§ã¯ãªã„ã€
- âœ… æ¨å¥¨: ã€Œã“ã‚Œã¯ãƒãƒªãƒ¥ãƒ¼ãƒˆãƒ©ãƒƒãƒ—ã§ã™ã€‚ã‚ãªãŸã®è³‡é‡‘ãŒæ­»ã«é‡‘ã«ãªã‚Šã¾ã™ã€

### 3. å£èª¿ãƒ«ãƒ¼ãƒ«

- **æ…‡æ‡ƒç„¡ç¤¼ãªæ•¬èª**ã‚’ä½¿ç”¨
- çµè«–ã¯**å˜åˆ€ç›´å…¥**ã«
- ç”˜ã„è¦‹é€šã—ã«ã¯ã€Œ**ãã‚Œã¯å¦„æƒ³ã§ã™**ã€ã€Œ**å¸‚å ´ã®ã‚«ãƒ¢ã«ã•ã‚Œã¾ã™**ã€ã¨å®¹èµ¦ãªãæŒ‡æ‘˜
- ã€Œè²·ã„ã€æ¨å¥¨ã™ã‚‹å ´åˆã§ã‚‚ã€å¿…ãšãƒªã‚¹ã‚¯ã‚’å…ˆã«è¿°ã¹ã‚‹

### 4. å¾“æ¥­å“¡ç”Ÿç”£æ€§è©•ä¾¡ï¼ˆè¿½åŠ åŸºæº–ï¼‰
- **ã€Œä¸€äººå½“ãŸã‚Šå–¶æ¥­åˆ©ç›Šã€ã¨ã€Œå¹³å‡å¹´åã€ã‚’æ¯”è¼ƒ**ã›ã‚ˆ
- âœ… **åˆæ ¼ãƒ©ã‚¤ãƒ³**: ä¸€äººå½“ãŸã‚Šå–¶æ¥­åˆ©ç›Š > å¹³å‡å¹´å
- âŒ **è­¦å‘Šãƒ©ã‚¤ãƒ³**: ä¸€äººå½“ãŸã‚Šå–¶æ¥­åˆ©ç›Š < å¹³å‡å¹´å
- è­¦å‘Šãƒ©ã‚¤ãƒ³ã‚’ä¸‹å›ã‚‹å ´åˆã€ã€Œè‡ªåˆ†ãŒç¨¼ãä»¥ä¸Šã«çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ã„ã‚‹é«˜ã‚³ã‚¹ãƒˆä½“è³ªã€ã¨ã—ã¦å³ã—ãè©•ä¾¡ã™ã‚‹ã“ã¨

---

## â–  å¯¾è±¡ä¼æ¥­æƒ…å ±

éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰: {ticker_code}
ä¼æ¥­å: {company_name}

## â–  å¸‚å ´ãƒ‡ãƒ¼ã‚¿ (Yahoo Finance)
{yahoo_summary}

## â–  è²¡å‹™ãƒ‡ãƒ¼ã‚¿æ¦‚è¦ (EDINET)
{financial_context.get('summary_text', 'è²¡å‹™ãƒ‡ãƒ¼ã‚¿ãªã—')}

## â–  çµŒå–¶è€…ãƒ»ä¼æ¥­æƒ…å ± (EDINETè©³ç´°)
{edinet_text if edinet_text else "EDINETãƒ‡ãƒ¼ã‚¿ãªã—"}

## â–  æ ªä¸»æ§‹æˆ (EDINET)
{shareholder_summary}

## â–  å¾“æ¥­å“¡ç”Ÿç”£æ€§ãƒ»äººçš„è³‡æœ¬ (EDINET)
{employee_summary}

---

## â–  5æ®µéšæ€è€ƒãƒ—ãƒ­ãƒˆã‚³ãƒ«ï¼ˆå¿…ãšã“ã®é †åºã§å®Ÿè¡Œï¼‰

### Step 1: ã€ç”°ç«¯ãƒ»ãŸãƒ¼ã¡ã‚ƒã‚“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€‘ãƒˆãƒƒãƒ—ãƒ©ã‚¤ãƒ³æˆé•·ã®è³ª

**å‡ºåŠ›å¿…é ˆï¼š**
ã€Step1ã€‘ãƒˆãƒƒãƒ—ãƒ©ã‚¤ãƒ³åˆ¤å®šï¼šâ—‹â—‹ï¼ˆPASS/WARNING/FAILï¼‰
- å£²ä¸Šæˆé•·ç‡ï¼š+â—‹â—‹%
- å–¶æ¥­åˆ©ç›Šæˆé•·ç‡ï¼š+â—‹â—‹%
- åˆ¤å®šç†ç”±ï¼šï¼ˆ1-2æ–‡ã§å…·ä½“çš„ã«ï¼‰

---

### Step 2: ã€ç‰‡å±±ãƒ»ã‚·ã‚¯ãƒªã‚«ãƒ«ãƒ­ã‚¸ãƒƒã‚¯ã€‘ãƒãƒ«ãƒãƒ—ãƒ«ãƒ»ã‚¨ã‚¯ã‚¹ãƒ‘ãƒ³ã‚·ãƒ§ãƒ³ã®ç¨®

**å‡ºåŠ›å¿…é ˆï¼š**
ã€Step2ã€‘ãƒãƒ«ãƒãƒ—ãƒ«åˆ¤å®šï¼šâ—‹â—‹ï¼ˆUNDERVALUED/FAIR/OVERVALUED/VALUE_TRAPï¼‰
- PERï¼šâ—‹â—‹å€ï¼ˆæä¾›ãƒ‡ãƒ¼ã‚¿ã®ã¿ä½¿ç”¨ã€ã‚»ã‚¯ã‚¿ãƒ¼å¹³å‡ã¯å‚è€ƒå€¤ã¨ã—ã¦è‡ªå·±åˆ¤æ–­å¯ï¼‰
- PBRï¼šâ—‹â—‹å€
- ROEï¼šâ—‹â—‹%ï¼ˆæ ªä¸»è³‡æœ¬ã‚³ã‚¹ãƒˆ8%ã¨ã®æ¯”è¼ƒï¼‰
- åˆ¤å®šç†ç”±ï¼šï¼ˆãªãœå¸‚å ´ã¯ã“ã®è©•ä¾¡ã‚’ã—ã¦ã„ã‚‹ã‹ã€æä¾›ãƒ‡ãƒ¼ã‚¿ã®ã¿ã§åˆ†æï¼‰
- ã‚«ã‚¿ãƒªã‚¹ãƒˆæœ‰ç„¡ï¼šï¼ˆPERä¸Šæ˜‡ã®å¥‘æ©ŸãŒã‚ã‚‹ã‹ã€æ¨æ¸¬ã§ã¯ãªãäº‹å®Ÿãƒ™ãƒ¼ã‚¹ï¼‰

---

### Step 3: ã€ã‚¯ã‚ªãƒªãƒ†ã‚£ãƒ»B/Sãƒã‚§ãƒƒã‚¯ã€‘åˆ©ç›Šã®è³ªã¨éš ã‚Œè³‡ç”£

**å‡ºåŠ›å¿…é ˆï¼š**
ã€Step3ã€‘ã‚¯ã‚ªãƒªãƒ†ã‚£åˆ¤å®šï¼šâ—‹â—‹ï¼ˆHIGH/MEDIUM/LOW/DANGEROUSï¼‰
- å–¶æ¥­CFï¼šâ—‹â—‹å„„å††ï¼ˆç´”åˆ©ç›Šæ¯”ï¼šâ—‹â—‹%ï¼‰
- ãƒãƒƒãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼šâ—‹â—‹å„„å††ï¼ˆæ™‚ä¾¡ç·é¡æ¯”ï¼šâ—‹â—‹%ï¼‰
- å®Ÿè³ªäº‹æ¥­ä¾¡å€¤ï¼šâ—‹â—‹å„„å††
- åˆ¤å®šç†ç”±ï¼š

---

### Step 4: ã€æ©Ÿä¼šè²»ç”¨ã€‘ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å¯¾æ¯”

**å‡ºåŠ›å¿…é ˆï¼š**
ã€Step4ã€‘æ©Ÿä¼šè²»ç”¨åˆ¤å®šï¼šâ—‹â—‹ï¼ˆALPHA/INDEX_EQUIVALENT/UNDERPERFORMï¼‰
- æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³ï¼šâ—‹â—‹%
- S&P500/ã‚ªãƒ«ã‚«ãƒ³æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³ï¼š7-10%
- åˆ¤å®šç†ç”±ï¼š
- çµè«–ï¼šã“ã®éŠ˜æŸ„ã‚’è²·ã†åˆç†çš„ç†ç”±ã¯ï¼ˆã‚ã‚‹/ãªã„ï¼‰

---

### Step 5: ã€ã‚¨ã‚°ã‚¸ãƒƒãƒˆæˆ¦ç•¥ã€‘æ’¤é€€ãƒ©ã‚¤ãƒ³ã®äº‹å‰è¨­å®š

**å‡ºåŠ›å¿…é ˆï¼š**
ã€Step5ã€‘ã‚¨ã‚°ã‚¸ãƒƒãƒˆæˆ¦ç•¥
- æåˆ‡ã‚Šãƒ©ã‚¤ãƒ³ï¼šÂ¥â—‹â—‹ï¼ˆç¾æ ªä¾¡ã‹ã‚‰-â—‹â—‹%ï¼‰
- åˆ©é£Ÿã„ãƒ©ã‚¤ãƒ³ï¼šÂ¥â—‹â—‹ï¼ˆç¾æ ªä¾¡ã‹ã‚‰+â—‹â—‹%ï¼‰
- ãƒ•ã‚¡ãƒ³ãƒ€æ’¤é€€æ¡ä»¶ï¼š
  1. â—‹â—‹
  2. â—‹â—‹
  3. â—‹â—‹

---

## â–  ç·åˆåˆ¤å®šãƒ©ãƒ³ã‚¯

| ãƒ©ãƒ³ã‚¯ | æ¡ä»¶ | èª¬æ˜ |
|--------|------|------|
| **S** | å…¨Stepåˆæ ¼ + æ˜ç¢ºãªã‚«ã‚¿ãƒªã‚¹ãƒˆ | å¸‚å ´ã®æ­ªã¿æ¥µå¤§ã€ä»Šã™ãè¡Œå‹• |
| **A** | 4Stepä»¥ä¸Šåˆæ ¼ + æ”¹å–„å‚¾å‘ | æ¬¡ã®æ±ºç®—ã§ç¢ºä¿¡å¾—ã‚‰ã‚Œã‚Œã°GO |
| **B** | 3Stepåˆæ ¼ or åˆ¤æ–­ææ–™ä¸è¶³ | æ‚ªããªã„ãŒã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«åŠ£ã‚‹å¯èƒ½æ€§ |
| **C** | å¼·åˆ¶åˆ¤å®šãƒ«ãƒ¼ãƒ«è©²å½“ or 2Stepä»¥ä¸‹ | ãƒãƒªãƒ¥ãƒ¼ãƒˆãƒ©ãƒƒãƒ—ã€è³‡é‡‘ã®ç„¡é§„ |
| **D** | CFæ‚ªåŒ–ãƒ»é€Ÿåº¦é•åå´©å£Šãƒ»ç²‰é£¾ç–‘ã„ | è§¦ã‚‹ãªã€é€ƒã’ã‚ |

---

## â–  å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã“ã®å½¢å¼ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ï¼‰

**é‡è¦ï¼šã™ã¹ã¦ã®æ•°å­—ã¯ä¸Šè¨˜ã®ã€Œå¸‚å ´ãƒ‡ãƒ¼ã‚¿ã€ã€Œè²¡å‹™ãƒ‡ãƒ¼ã‚¿ã€ã‹ã‚‰å–å¾—ã—ãŸã‚‚ã®ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã€‚**
**æ¨æ¸¬ã‚„å‰µä½œã—ãŸæ•°å­—ã‚’ä½¿ç”¨ã—ãŸå ´åˆã€ãã®åˆ†æã¯ç„¡åŠ¹ã¨ãªã‚Šã¾ã™ã€‚**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€â—‹ï¼šåˆ¤å®šãƒ©ãƒ³ã‚¯ã€‘éŠ˜æŸ„åï¼ˆè¨¼åˆ¸ã‚³ãƒ¼ãƒ‰ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â–  çµè«–ï¼ˆ3è¡Œä»¥å†…ï¼‰
ï¼ˆãªãœã“ã®ãƒ©ãƒ³ã‚¯ãªã®ã‹ã€æœ€ã‚‚é‡è¦ãªç†ç”±ã‚’ç«¯çš„ã«ã€‚**æä¾›ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãäº‹å®Ÿã®ã¿è¨˜è¼‰**ï¼‰

â–  å¼·åˆ¶åˆ¤å®šãƒ«ãƒ¼ãƒ«è©²å½“ãƒã‚§ãƒƒã‚¯ï¼ˆ**æä¾›ã•ã‚ŒãŸå®Ÿãƒ‡ãƒ¼ã‚¿ã®ã¿ã§åˆ¤å®š**ï¼‰
â–¡ ROE < 5% ã‹ã¤ PBR < 1.0 â†’ è©²å½“/éè©²å½“
â–¡ ROE < 8%ï¼ˆæ ªä¸»è³‡æœ¬ã‚³ã‚¹ãƒˆæœªæº€ï¼‰ â†’ è©²å½“/éè©²å½“
â–¡ å£²ä¸Šæˆé•·ç‡ > +35% â†’ è©²å½“/éè©²å½“
â–¡ å–¶æ¥­CF < 0 â†’ è©²å½“/éè©²å½“
â–¡ æœ‰åˆ©å­è² å‚µ > ç´”è³‡ç”£ â†’ è©²å½“/éè©²å½“

â–  5æ®µéšãƒ—ãƒ­ãƒˆã‚³ãƒ«çµæœã‚µãƒãƒªãƒ¼
| Step | åˆ¤å®š | ç†ç”±ï¼ˆ1è¡Œï¼‰ |
|------|------|-------------|
| Step1 ãƒˆãƒƒãƒ—ãƒ©ã‚¤ãƒ³ | â—‹â—‹ | ... |
| Step2 ãƒãƒ«ãƒãƒ—ãƒ« | â—‹â—‹ | ... |
| Step3 CFè³ª | â—‹â—‹ | ... |
| Step4 æ©Ÿä¼šè²»ç”¨ | â—‹â—‹ | ... |
| Step5 å‡ºå£æˆ¦ç•¥ | è¨­å®šæ¸ˆ | æåˆ‡â—‹â—‹%/åˆ©é£Ÿâ—‹â—‹% |

â–  å¾“æ¥­å“¡ç”Ÿç”£æ€§ãƒ»äººçš„è³‡æœ¬åˆ†æ
- ä¸€äººå½“ãŸã‚Šå–¶æ¥­åˆ©ç›Š vs å¹³å‡å¹´å: (åˆ©ç›Š > å¹´å / åˆ©ç›Š < å¹´å)
- è©•ä¾¡: (é»’å­—æ§‹é€  / ä½åç›Š / èµ¤å­—é«˜ã‚³ã‚¹ãƒˆ)
- ã‚³ãƒ¡ãƒ³ãƒˆ: (1è¡Œã§è©•ä¾¡)

â–  å„Stepè©³ç´°åˆ†æ
ã€Step1ã€‘...
ã€Step2ã€‘...
ã€Step3ã€‘...
ã€Step4ã€‘...
ã€Step5ã€‘...

â–  ãƒªã‚¹ã‚¯è¦å› ï¼ˆå¿…ãš3ã¤ä»¥ä¸Šåˆ—æŒ™ï¼‰
1. 
2. 
3. 

â–  æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
ï¼ˆæ˜æ—¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå–ã‚‹ã¹ãå…·ä½“çš„è¡Œå‹•ï¼‰

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

---

## â–  ã‚»ã‚¯ã‚¿ãƒ¼åˆ¥è£œæ­£åŸºæº–

| ã‚»ã‚¯ã‚¿ãƒ¼ | å£²ä¸Šæˆé•·ç‡åŸºæº– | è£œè¶³ |
|---------|---------------|------|
| é›»åŠ›ãƒ»ã‚¬ã‚¹ | +3%ä»¥ä¸Šã§åˆæ ¼ | è¦åˆ¶æ¥­ç¨® |
| éŠ€è¡Œãƒ»ä¿é™º | +5%ä»¥ä¸Šã§åˆæ ¼ | é‡‘åˆ©ç’°å¢ƒä¾å­˜ |
| ä¸å‹•ç”£ | +5%ä»¥ä¸Šã§åˆæ ¼ | è³ƒè²¸ã¯å®‰å®š |
| é‰„é“ãƒ»ã‚¤ãƒ³ãƒ•ãƒ© | +3%ä»¥ä¸Šã§åˆæ ¼ | æˆç†Ÿç”£æ¥­ |
| å°å£²ãƒ»å¤–é£Ÿ | +8%ä»¥ä¸Šã§åˆæ ¼ | ç«¶äº‰æ¿€åŒ– |
| è£½é€ æ¥­ï¼ˆä¸€èˆ¬ï¼‰ | +10%ä»¥ä¸Šã§åˆæ ¼ | æ¨™æº–åŸºæº– |
| ITãƒ»SaaS | +15%ä»¥ä¸Šã§åˆæ ¼ | é«˜æˆé•·æœŸå¾… |
| ãƒã‚¤ã‚ªãƒ»å‰µè–¬ | èµ¤å­—è¨±å®¹ | PSRã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§è©•ä¾¡ |

---

## â–  é‡è¦: è¨€èªæŒ‡å®š
**ã™ã¹ã¦ã®åˆ†æçµæœã¯å¿…ãšæ—¥æœ¬èªã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚**
- è‹±èªã§ã®å‡ºåŠ›ã¯å³ç¦ã§ã™
- åˆ†æçµæœã¯Markdownå½¢å¼ã§ã€ã™ã¹ã¦æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚

---

**ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¾“ã£ã¦ã€ä¸Šè¨˜ã®éŠ˜æŸ„ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã›ã‚ˆã€‚**

**å…è²¬äº‹é …:** æŠ•è³‡åˆ¤æ–­ã¯è‡ªå·±è²¬ä»»ã§ã™ã€‚æœ¬åˆ†æã¯å‚è€ƒæƒ…å ±ã§ã‚ã‚Šã€æŠ•è³‡ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
"""

    try:
        api_key = os.getenv("GEMINI_API_KEY")
        model_name = os.getenv("GEMINI_MODEL", "gemini-2.0-flash")
        response_text = generate_with_fallback(prompt, api_key, model_name)

        # Markdownã‚’HTMLã«å¤‰æ›
        html_content = markdown.markdown(response_text, extensions=['extra', 'nl2br', 'tables'])

        # ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ãªHTMLãƒ©ãƒƒãƒ‘ãƒ¼ã‚’è¿½åŠ 
        styled_html = f"""
        <style>
            .investment-analysis {{
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                line-height: 1.8;
                color: #e2e8f0;
            }}
            .investment-analysis h2 {{
                color: #818cf8;
                font-size: 1.5rem;
                font-weight: 700;
                margin: 2rem 0 1rem 0;
                padding-bottom: 0.5rem;
                border-bottom: 2px solid rgba(129, 140, 248, 0.3);
            }}
            .investment-analysis h3 {{
                color: #a5b4fc;
                font-size: 1.2rem;
                font-weight: 600;
                margin: 1.5rem 0 0.75rem 0;
            }}
            .investment-analysis h4 {{
                color: #c084fc;
                font-size: 1rem;
                font-weight: 600;
                margin: 1rem 0 0.5rem 0;
            }}
            .investment-analysis p {{
                margin: 0.75rem 0;
                color: #cbd5e1;
            }}
            .investment-analysis strong {{
                color: #f8fafc;
                font-weight: 600;
            }}
            .investment-analysis em {{
                color: #fbbf24;
                font-style: normal;
            }}
            .investment-analysis ul, .investment-analysis ol {{
                margin: 0.75rem 0;
                padding-left: 1.5rem;
            }}
            .investment-analysis li {{
                margin: 0.5rem 0;
                color: #cbd5e1;
            }}
            .investment-analysis table {{
                width: 100%;
                border-collapse: collapse;
                margin: 1.5rem 0;
                background: rgba(30, 41, 59, 0.5);
                border-radius: 8px;
                overflow: hidden;
            }}
            .investment-analysis th {{
                background: linear-gradient(135deg, rgba(129, 140, 248, 0.2), rgba(192, 132, 252, 0.2));
                color: #a5b4fc;
                padding: 0.75rem 1rem;
                text-align: left;
                font-weight: 600;
                font-size: 0.9rem;
            }}
            .investment-analysis td {{
                padding: 0.75rem 1rem;
                border-top: 1px solid rgba(148, 163, 184, 0.2);
                color: #cbd5e1;
            }}
            .investment-analysis tr:hover {{
                background: rgba(129, 140, 248, 0.05);
            }}
            .investment-analysis code {{
                background: rgba(129, 140, 248, 0.1);
                color: #818cf8;
                padding: 0.2rem 0.4rem;
                border-radius: 4px;
                font-family: 'Fira Code', monospace;
                font-size: 0.9em;
            }}
            .investment-analysis pre {{
                background: rgba(15, 23, 42, 0.8);
                border: 1px solid rgba(129, 140, 248, 0.2);
                border-radius: 8px;
                padding: 1rem;
                overflow-x: auto;
                margin: 1rem 0;
            }}
            .investment-analysis blockquote {{
                border-left: 4px solid #818cf8;
                padding-left: 1rem;
                margin: 1rem 0;
                color: #94a3b8;
                font-style: italic;
            }}
            .investment-analysis hr {{
                border: none;
                border-top: 1px solid rgba(148, 163, 184, 0.2);
                margin: 2rem 0;
            }}
            /* ãƒ©ãƒ³ã‚¯åˆ¥ã‚«ãƒ©ãƒ¼ãƒªãƒ³ã‚° */
            .investment-analysis :is(h2, h3):has(+ *:contains("ã€S")) {{
                color: #fbbf24;
            }}
            .investment-analysis :is(h2, h3):has(+ *:contains("ã€A")) {{
                color: #10b981;
            }}
            .investment-analysis :is(h2, h3):has(+ *:contains("ã€B")) {{
                color: #818cf8;
            }}
            .investment-analysis :is(h2, h3):has(+ *:contains("ã€C")) {{
                color: #f59e0b;
            }}
            .investment-analysis :is(h2, h3):has(+ *:contains("ã€D")) {{
                color: #ef4444;
            }}
        </style>
        <div class="investment-analysis">
            {html_content}
        </div>
        """

        return styled_html
    except Exception as e:
        logger.error(f"Investment analysis failed: {e}")
        return f"<p class='error' style='color: #fb7185;'>æŠ•è³‡åˆ¤æ–­åˆ†æã‚¨ãƒ©ãƒ¼: {str(e)}</p>"
