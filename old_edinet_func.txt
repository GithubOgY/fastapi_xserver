@app.post("/api/edinet/search")
async def search_edinet_company(
    company_name: str = Form(...),
    current_user: User = Depends(get_current_user)
):
    """Search company financial data from EDINET (Latest)"""
    if not current_user:
        raise HTTPException(status_code=401, detail="Not authenticated")
    
    try:
        from utils.edinet_enhanced import search_company_reports, process_document, format_financial_data
        
        # Search for documents
        docs = search_company_reports(company_name=company_name, doc_type="120", days_back=365)
        
        if not docs:
            # Try quarterly report
            docs = search_company_reports(company_name=company_name, doc_type="140", days_back=180)
        
        if not docs:
            return HTMLResponse(content=f"""
                <div class="alert alert-error">
                    ❌ 「{company_name}」の書類が見つかりませんでした。
                </div>
            """)
        
        doc = docs[0]
        sec_code = doc.get("secCode", "")
        
        # Process document
        result = process_document(doc)
        
        if not result:
             return HTMLResponse(content="""
                <div class="alert alert-error">
                    ❌ データの取得・解析に失敗しました。
                </div>
            """)
            
        metadata = result.get("metadata", {})
        normalized = result.get("normalized_data", {})
        text_data = result.get("text_data", {})
        website_url = result.get("website_url")
        formatted_normalized = format_financial_data(normalized)
        
        # Qualitative Information Sections
        sections_html = ""
        text_keys = ["経営者による分析", "対処すべき課題", "事業等のリスク", "研究開発活動"]
        
        for key in text_keys:
            content = text_data.get(key)
            if content:
                # Truncate for preview (first 300 chars)
                preview = content[:300] + "..." if len(content) > 300 else content
                
                # HTML for expandable section - NO SVG icons, simple text only
                sections_html += f"""
                <details class="mb-3 bg-gray-900/30 rounded-lg border border-gray-700/50 overflow-hidden">
                    <summary class="cursor-pointer p-4 bg-gray-800/50 hover:bg-gray-700/50 transition-colors font-medium text-gray-200 list-none flex items-center justify-between">
                        <span>{key}</span>
                        <span class="text-gray-500 text-sm">クリックして展開</span>
                    </summary>
                    <div class="p-6 text-base text-gray-200 leading-loose border-t border-gray-700/50 bg-gray-900/50" style="white-space: pre-wrap; line-height: 2;">
                        {content}
                    </div>
                </details>
                """

        history_btn = ""
        if sec_code:
            code_only = sec_code[:4] # First 4 digits
            history_btn = f"""
            <style>
                .btn-loading {{ display: none; }}
                .htmx-request .btn-default {{ display: none; }}
                .htmx-request .btn-loading {{ display: inline; }}
            </style>
            <button hx-get="/api/edinet/history/{code_only}" 
                    hx-target="#edinet-history-container" 
                    hx-swap="innerHTML"
                    class="mt-10 w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition-all">
                <span class="btn-default">直近の財務推移グラフを表示</span>
                <span class="btn-loading">⏳ データ取得中... (数十秒かかる場合があります)</span>
            </button>
            <div id="edinet-history-container" class="mt-4"></div>
            """
        
        # Website link HTML
        website_html = ""
        if website_url:
            website_html = f'<a href="{website_url}" target="_blank" rel="noopener" class="text-blue-400 hover:text-blue-300 underline text-sm">企業サイト</a>'

        # AI Analysis Button for EDINET
        ai_btn = ""
        if sec_code:
            code_only = sec_code[:4]
            ai_btn = f"""
            <div style="margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
                <h4 style="font-size: 1.2rem; font-weight: bold; text-align: center; margin-bottom: 1rem; background: linear-gradient(to right, #c084fc, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-block; width: 100%;">
                    🤖 AIアナリスト・レポート
                </h4>
                <div id="ai-analysis-container">
                    <button id="ai-gen-btn-{code_only}" 
                        style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #9333ea, #db2777); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s;"
                        onmouseover="this.style.opacity='0.9'"
                        onmouseout="this.style.opacity='1'"
                        hx-post="/api/ai/analyze"
                        hx-target="#ai-analysis-content"
                        hx-vals='{{"ticker_code": "{code_only}"}}'
                        onclick="document.getElementById('btn-txt-{code_only}').style.display='none'; document.getElementById('btn-load-{code_only}').style.display='flex'; this.disabled=true; this.style.opacity='0.7'; this.style.cursor='wait';"
                        hx-on::after-request="document.getElementById('btn-txt-{code_only}').style.display='block'; document.getElementById('btn-load-{code_only}').style.display='none'; this.disabled=false; this.style.opacity='1'; this.style.cursor='pointer';">
                        
                        <span id="btn-txt-{code_only}">AIによる詳細分析を生成 (Gemini 2.0 Flash)</span>
                        
                        <span id="btn-load-{code_only}" style="display: none; align-items: center; gap: 0.5rem;">
                            <span style="border: 2px solid white; border-top-color: transparent; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite;"></span>
                            <span>分析を生成中... (数秒かかります)</span>
                        </span>
                    </button>
                    <style>@keyframes spin {{ to {{ transform: rotate(360deg); }} }}</style>
                    <div id="ai-analysis-content" style="margin-top: 1rem; color: #e2e8f0; line-height: 1.7; font-size: 0.95rem;"></div>
                </div>
            </div>
            """
        
        return HTMLResponse(content=f"""
            <div class="bg-gray-800/80 backdrop-blur-md border border-gray-700 rounded-xl p-6 shadow-2xl animate-fade-in-up">
                <div class="flex items-start justify-between mb-6 pb-4 border-b border-gray-700">
                    <div>
                        <div class="flex items-center gap-3">
                            <h3 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300">
                                {metadata.get('company_name')}
                            </h3>
                            <span class="px-2 py-1 bg-gray-700 text-gray-300 text-xs font-mono rounded-md border border-gray-600">{sec_code}</span>
                            {website_html}
                        </div>
                        <div class="flex items-center gap-2 mt-2 text-sm text-gray-400">
                            <span class="bg-gray-900/50 px-2 py-1 rounded">{metadata.get('document_type')}</span>
                            <span class="text-xs text-gray-500">提出: {metadata.get('submit_date')}</span>
                            {'<span class="text-xs text-green-400 bg-green-900/30 px-2 py-1 rounded">⚡ キャッシュ</span>' if metadata.get('from_cache') else ''}
                        </div>
                    </div>
                </div>
                
                <!-- Key Financials Summary - Inline format -->
                <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700/50 mb-6 font-mono text-sm">
                    <div class="grid grid-cols-2 gap-2">
                        <div class="text-gray-300">売上高　<span class="text-gray-100">{formatted_normalized.get("売上高", "-")}</span></div>
                        <div class="text-gray-300">営業利益　<span class="text-emerald-400">{formatted_normalized.get("営業利益", "-")}</span></div>
                        <div class="text-gray-300">当期純利益　<span class="text-blue-400">{formatted_normalized.get("当期純利益", "-")}</span></div>
                        <div class="text-gray-300">ROE　<span class="text-purple-400">{formatted_normalized.get("ROE", "-")}</span></div>
                        <div class="text-gray-300">ROA　<span class="text-purple-400">{formatted_normalized.get("ROA", "-")}</span></div>
                        <div class="text-gray-300">自己資本比率　<span class="text-yellow-400">{formatted_normalized.get("自己資本比率", "-")}</span></div>
                    </div>
                </div>
                
                <h4 class="text-lg font-bold text-gray-200 mb-4 border-l-4 border-indigo-500 pl-3">
                    定性情報レポート
                </h4>
                
                {sections_html if sections_html else "<div class='text-gray-500 p-4 text-center bg-gray-900/30 rounded-lg'>詳細なテキスト情報はこのドキュメントに含まれていません。</div>"}
                
                {history_btn}
                {ai_btn}
            </div>
        """)
        
        # Create response and set cookie to remember last EDINET search
        response = HTMLResponse(content=html_content)
        response.set_cookie(key="last_edinet_query", value=company_name, max_age=86400*30)  # 30 days
        return response
        
    except Exception as e:
        import traceback
        traceback.print_exc()
        return HTMLResponse(content=f"""
            <div class="alert alert-error">
                ❌ エラー: {str(e)}
            </div>
        """, status_code=500)
